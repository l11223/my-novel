name: Build strongR-frida

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/build_strongR.yml'

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 18
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: 3.9
        
    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r25c
        local-cache: false
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential ninja-build gcc-multilib \
          g++-multilib lib32stdc++-9-dev flex bison ruby ruby-dev \
          python3-requests python3-setuptools python3-dev python3-pip git
        sudo gem install fpm -v 1.11.0 --no-document
        pip3 install lief graphlib
        
    - name: Clone Frida
      run: |
        git clone --recurse-submodules https://github.com/frida/frida.git
        cd frida
        git checkout 17.5.2
        
    - name: Clone strongR patches
      run: |
        git clone https://github.com/AAAA-Project/Patchs.git
        
    - name: Configure Git
      run: |
        git config --global user.email "bot@github.com"
        git config --global user.name "GitHub Actions"
        
    - name: Apply patches
      run: |
        cd frida/subprojects/frida-core
        for patch in ../../../Patchs/strongR-frida/frida-core/*.patch; do
          echo "Applying: $patch"
          if [ -f "$patch" ]; then
            git am "$patch" || {
              git am --abort 2>/dev/null || true
              git apply "$patch" || {
                echo "Warning: Failed to apply $patch, continuing..."
              }
            }
          fi
        done
        
    - name: Build ARM64
      run: |
        cd frida
        ./configure --host=android-arm64 --enable-portal
        make -j$(nproc)
        
    - name: Package artifacts
      run: |
        cd frida
        # 查找编译产物
        FRIDA_SERVER=$(find . -name "frida-server" -type f | grep -v ".git" | head -1)
        FRIDA_INJECT=$(find . -name "frida-inject" -type f | grep -v ".git" | head -1)
        FRIDA_GADGET=$(find . -name "frida-gadget.so" -type f | grep -v ".git" | head -1)
        
        if [ -n "$FRIDA_SERVER" ]; then
          gzip -f "$FRIDA_SERVER"
          echo "FRIDA_SERVER_PATH=${FRIDA_SERVER}.gz" >> $GITHUB_ENV
        fi
        
        if [ -n "$FRIDA_INJECT" ]; then
          gzip -f "$FRIDA_INJECT"
          echo "FRIDA_INJECT_PATH=${FRIDA_INJECT}.gz" >> $GITHUB_ENV
        fi
        
        if [ -n "$FRIDA_GADGET" ]; then
          gzip -f "$FRIDA_GADGET"
          echo "FRIDA_GADGET_PATH=${FRIDA_GADGET}.gz" >> $GITHUB_ENV
        fi
        
    - name: Upload frida-server
      uses: actions/upload-artifact@v4
      if: env.FRIDA_SERVER_PATH != ''
      with:
        name: frida-server-17.5.2-android-arm64
        path: ${{ env.FRIDA_SERVER_PATH }}
        
    - name: Upload frida-inject
      uses: actions/upload-artifact@v4
      if: env.FRIDA_INJECT_PATH != ''
      with:
        name: frida-inject-17.5.2-android-arm64
        path: ${{ env.FRIDA_INJECT_PATH }}
        
    - name: Upload frida-gadget
      uses: actions/upload-artifact@v4
      if: env.FRIDA_GADGET_PATH != ''
      with:
        name: frida-gadget-17.5.2-android-arm64
        path: ${{ env.FRIDA_GADGET_PATH }}
